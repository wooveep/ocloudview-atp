# Guest éªŒè¯å™¨æœåŠ¡ç«¯è®¾è®¡

## æ¶æ„æ¦‚è¿°

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ATP æ‰§è¡Œå™¨ (Executor)                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  å‘é€è¾“å…¥äº‹ä»¶ (é”®ç›˜/é¼ æ ‡/å‘½ä»¤)                        â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                   â†“                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚         VerificationService (æ–°å¢)                   â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚    â”‚
â”‚  â”‚  â”‚ äº‹ä»¶è·Ÿè¸ªå™¨   â”‚  â”‚ ç»“æœåŒ¹é…å™¨   â”‚                â”‚    â”‚
â”‚  â”‚  â”‚ (EventIdç”Ÿæˆ)â”‚  â”‚ (å¯¹æ¯”éªŒè¯)   â”‚                â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚    VerificationServer (æ–°å¢)          â”‚
     â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
     â”‚  â”‚ WebSocket  â”‚  â”‚    TCP     â”‚     â”‚
     â”‚  â”‚   Server   â”‚  â”‚   Server   â”‚     â”‚
     â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
     â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
     â•‘         Guest OS (è™šæ‹Ÿæœºå†…éƒ¨)         â•‘
     â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â•‘
     â•‘  â”‚   verifier-agent (å®¢æˆ·ç«¯)     â”‚   â•‘
     â•‘  â”‚  - æ¥æ”¶äº‹ä»¶                   â”‚   â•‘
     â•‘  â”‚  - éªŒè¯è¾“å…¥                   â”‚   â•‘
     â•‘  â”‚  - è¿”å›ç»“æœ                   â”‚   â•‘
     â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â•‘
     â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

## æ ¸å¿ƒç»„ä»¶

### 1. VerificationServer (æœåŠ¡ç«¯)
- **èŒè´£**: æ¥æ”¶å®¢æˆ·ç«¯è¿æ¥ï¼Œè½¬å‘äº‹ä»¶ï¼Œæ”¶é›†ç»“æœ
- **ä½ç½®**: `atp-core/verification-server/`
- **åŠŸèƒ½**:
  - WebSocket æœåŠ¡å™¨ï¼ˆå¤šå®¢æˆ·ç«¯è¿æ¥ï¼‰
  - TCP æœåŠ¡å™¨ï¼ˆå¤šå®¢æˆ·ç«¯è¿æ¥ï¼‰
  - å®¢æˆ·ç«¯ä¼šè¯ç®¡ç†
  - äº‹ä»¶è·¯ç”±ï¼ˆæ ¹æ® VM IDï¼‰
  - ç»“æœæ”¶é›†

### 2. VerificationService (æœåŠ¡å±‚)
- **èŒè´£**: äº‹ä»¶è·Ÿè¸ªã€ç»“æœåŒ¹é…ã€éªŒè¯é€»è¾‘
- **ä½ç½®**: `atp-core/verification-server/`
- **åŠŸèƒ½**:
  - ç”Ÿæˆå”¯ä¸€äº‹ä»¶ IDï¼ˆUUIDï¼‰
  - è·Ÿè¸ªå¾…éªŒè¯äº‹ä»¶
  - åŒ¹é…äº‹ä»¶å’Œç»“æœï¼ˆevent_id å¯¹åº”ï¼‰
  - è¶…æ—¶å¤„ç†
  - å¹¶å‘å®‰å…¨ï¼ˆå¤š VM åŒæ—¶éªŒè¯ï¼‰

### 3. Executor é›†æˆ
- **ä¿®æ”¹**: `atp-core/executor/src/runner.rs`
- **åŠŸèƒ½**:
  - å‘é€è¾“å…¥å‰ï¼Œå‘ VerificationService æ³¨å†Œäº‹ä»¶
  - å¼‚æ­¥ç­‰å¾…éªŒè¯ç»“æœ
  - åœ¨æµ‹è¯•æŠ¥å‘Šä¸­è®°å½•éªŒè¯çŠ¶æ€

## æ•°æ®æµ

### å‘é€äº‹ä»¶æµç¨‹
```
1. Executor å‡†å¤‡å‘é€è¾“å…¥ (ä¾‹å¦‚: é”®ç›˜ 'A')
2. ç”Ÿæˆ event_id = UUID::new_v4()
3. å‘ VerificationService æ³¨å†Œ: (vm_id, event_id, event_data)
4. é€šè¿‡ VerificationServer å‘é€åˆ°å¯¹åº” Guest Agent
5. Guest Agent æ”¶åˆ°äº‹ä»¶ï¼Œå¼€å§‹ç›‘å¬è¾“å…¥
6. Executor å®é™…å‘é€è¾“å…¥åˆ° VM (é€šè¿‡ QMP/SPICE ç­‰)
```

### æ¥æ”¶ç»“æœæµç¨‹
```
1. Guest Agent æ£€æµ‹åˆ°è¾“å…¥ (ä¾‹å¦‚: é”®ç›˜ 'A')
2. ç”ŸæˆéªŒè¯ç»“æœ (event_id, verified, latency)
3. é€šè¿‡ WebSocket/TCP è¿”å›ç»™ VerificationServer
4. VerificationServer è½¬å‘ç»™ VerificationService
5. VerificationService æ ¹æ® event_id åŒ¹é…å¾…éªŒè¯äº‹ä»¶
6. è¿”å›ç»“æœç»™ Executor
7. Executor åœ¨æŠ¥å‘Šä¸­è®°å½•: verified=true, latency=15ms
```

## å¹¶å‘å¤„ç†

### å¤š VM å¹¶å‘åœºæ™¯
```rust
// æ¯ä¸ª VM æœ‰ç‹¬ç«‹çš„å®¢æˆ·ç«¯è¿æ¥
HashMap<VmId, ClientConnection>

// æ¯ä¸ªäº‹ä»¶æœ‰å”¯ä¸€ ID
struct PendingEvent {
    event_id: Uuid,
    vm_id: String,
    event_data: Event,
    sender: oneshot::Sender<VerifyResult>,
    timestamp: Instant,
}

// ä½¿ç”¨ event_id ç²¾ç¡®åŒ¹é…
pending_events: HashMap<Uuid, PendingEvent>
```

### å®¢æˆ·ç«¯éš”ç¦»
- æ¯ä¸ª Guest Agent è¿æ¥æ—¶æä¾› `vm_id`
- æœåŠ¡ç«¯ç»´æŠ¤ `vm_id -> connection` æ˜ å°„
- å‘é€äº‹ä»¶æ—¶è·¯ç”±åˆ°æ­£ç¡®çš„å®¢æˆ·ç«¯
- æ¥æ”¶ç»“æœæ—¶é€šè¿‡ `event_id` åŒ¹é…

## API è®¾è®¡

### VerificationService API
```rust
pub struct VerificationService {
    server: Arc<VerificationServer>,
    pending_events: Arc<RwLock<HashMap<Uuid, PendingEvent>>>,
}

impl VerificationService {
    /// å‘é€éªŒè¯äº‹ä»¶å¹¶ç­‰å¾…ç»“æœ
    pub async fn verify_event(
        &self,
        vm_id: &str,
        event: Event,
        timeout: Duration,
    ) -> Result<VerifyResult>;

    /// æ³¨å†Œå®¢æˆ·ç«¯ï¼ˆä» Guest Agentï¼‰
    pub async fn register_client(
        &self,
        vm_id: String,
        connection: ClientConnection,
    ) -> Result<()>;
}
```

### Executor é›†æˆ
```rust
// åœ¨ ScenarioRunner ä¸­
pub struct ScenarioRunner {
    // ... ç°æœ‰å­—æ®µ
    verification_service: Option<Arc<VerificationService>>,
}

// å‘é€é”®ç›˜è¾“å…¥æ—¶
async fn send_keyboard(&self, key: &str) -> Result<StepResult> {
    // 1. åˆ›å»ºéªŒè¯äº‹ä»¶
    let event = Event {
        event_type: "keyboard".to_string(),
        data: json!({ "key": key }),
        timestamp: now(),
    };

    // 2. å‘é€éªŒè¯è¯·æ±‚ï¼ˆå¼‚æ­¥ï¼‰
    let verify_future = if let Some(service) = &self.verification_service {
        Some(service.verify_event(&self.vm_id, event, timeout))
    } else {
        None
    };

    // 3. å®é™…å‘é€è¾“å…¥
    self.protocol.send_key(key).await?;

    // 4. ç­‰å¾…éªŒè¯ç»“æœ
    let verified = if let Some(future) = verify_future {
        match future.await {
            Ok(result) => result.verified,
            Err(e) => {
                warn!("éªŒè¯å¤±è´¥: {}", e);
                false
            }
        }
    } else {
        true // æœªå¯ç”¨éªŒè¯
    };

    Ok(StepResult { success: true, verified, ... })
}
```

## é…ç½®

### Server é…ç½®
```toml
[verification_server]
enabled = true
websocket_port = 8765
tcp_port = 8766
max_clients = 100
event_timeout = 5000  # ms
```

### Client é…ç½® (Guest Agent)
```bash
# å¯åŠ¨æ—¶æä¾› VM ID
verifier-agent \
  --server ws://192.168.1.100:8765 \
  --vm-id vm-12345 \
  --verifiers keyboard mouse command
```

## é”™è¯¯å¤„ç†

### è¶…æ—¶
- äº‹ä»¶å‘é€åï¼Œåœ¨æŒ‡å®šæ—¶é—´å†…æœªæ”¶åˆ°ç»“æœ
- è¿”å› `verified=false, timeout=true`

### å®¢æˆ·ç«¯æ–­è¿
- æ£€æµ‹åˆ°å®¢æˆ·ç«¯æ–­å¼€è¿æ¥
- æ‰€æœ‰è¯¥å®¢æˆ·ç«¯çš„å¾…éªŒè¯äº‹ä»¶æ ‡è®°ä¸ºå¤±è´¥

### å¹¶å‘å†²çª
- ç†è®ºä¸Šä¸ä¼šå‘ç”Ÿï¼ˆevent_id å”¯ä¸€ï¼‰
- å¦‚æœå‘ç”Ÿï¼Œè®°å½•é”™è¯¯æ—¥å¿—

## ä¸‹ä¸€æ­¥å®ç°

1. âœ… å®¢æˆ·ç«¯å·²å®Œæˆï¼ˆverifier-agentï¼‰
2. ğŸ“ å®ç° VerificationServer
   - WebSocket æœåŠ¡å™¨
   - TCP æœåŠ¡å™¨
   - å®¢æˆ·ç«¯ç®¡ç†
3. ğŸ“ å®ç° VerificationService
   - äº‹ä»¶è·Ÿè¸ª
   - ç»“æœåŒ¹é…
   - è¶…æ—¶å¤„ç†
4. ğŸ“ é›†æˆåˆ° Executor
   - ä¿®æ”¹ ScenarioRunner
   - æ·»åŠ éªŒè¯é€»è¾‘
   - æ›´æ–°æŠ¥å‘Šæ ¼å¼
